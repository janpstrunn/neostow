#!/usr/bin/env bash

NEOSTOW_FILE="$PWD/.neostow"
DIR=$PWD

function help() {
  cat <<EOF
Neostow
Usage: neostow [flag] [command]
Available flags:
-d                       - Remove all symlinks
-r                       - Overwrite symlinks
-t <absolute_path>       - Target a different project directory
-v                       - Enable verbose
Available commands:
help                   - Displays this message and exits
EOF
}

function create_links() {
  local source_file dest_folder file message
  source_file="$1"
  dest_folder=$2
  file=$(basename "$source_file")
  message="Created"
  if [ -n "$OVERWRITE" ]; then
    ln -sf "$source_file" "$dest_folder"
  elif [ -n "$DELETE" ]; then
    message="Deleted"
    rm "$dest_folder/$file"
  elif [ -n "$ADOPT" ]; then
    message="Adopted"
    adopt "$source_file" "$dest_folder"
  else
    ln -s "$source_file" "$dest_folder"
  fi
  if [ -n "$VERBOSE" ]; then
    echo "$message symlink: $dest_folder/$file"
  fi
}

function main() {
  if [[ ! -f "$NEOSTOW_FILE" ]]; then
    echo "Error: $NEOSTOW_FILE not found"
    exit 1
  fi
  local file_lines i threshold source_file dest_folder working_data
  declare -i file_lines
  declare -i i
  file_lines=$(wc -l <"$NEOSTOW_FILE")
  i=1
  declare -i threshold=("$file_lines"+1)
  while [ "$i" -lt "$threshold" ]; do
    working_data=$(bat --line-range "$i":"$i" "$NEOSTOW_FILE")
    source_file="$DIR/$(awk -F '=' '{print $1}' <<<"$working_data")"
    if [[ -f "$source_file" ]] || [[ -d "$source_file" ]]; then
      dest_folder=$(awk -F '=' '{print $2}' <<<"$working_data")
      eval dest_folder="$dest_folder"
      create_links "$source_file" "$dest_folder"
    else
      if [ -n "$VERBOSE" ]; then
        echo "File or directory $source_file does not exist. Skipping..."
      fi
      continue
    fi
    i+=1
    unset working_data
  done
}

while getopts ":hdrt:v" opt; do
  case "$opt" in
  r)
    OVERWRITE=true
    ;;
  d)
    DELETE=true
    ;;
  h)
    help
    exit 0
    ;;
  t)
    DIR="$OPTARG"
    NEOSTOW_FILE="$OPTARG/.neostow"
    ;;
  v)
    VERBOSE=true
    ;;
  ?)
    echo "Error: Invalid option '-$OPTARG'" >&2
    exit 1
    ;;
  esac
done

shift $((OPTIND - 1))

case "$1" in
help)
  help
  exit 0
  ;;
esac

main
