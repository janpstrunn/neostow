#!/usr/bin/env bash

NEOSTOW_FILE="$PWD/.neostow"
PATH=$PWD

function help() {
  cat <<EOF
Neostow
Usage: neostow [flag] [command]
Available flags:
-d                     - Remove all symlinks
-r                     - Overwrite symlinks
-t                     - Target a different project directory
Available commands:
adopt                  - Adopt already existing file or directory
help                   - Displays this message and exits
EOF
}

function create_links() {
  local source_file dest_folder
  source_file="$PATH/$1"
  dest_folder=$2
  if [ -n "$OVERWRITE" ]; then
    ln -sf "$source_file" "$dest_folder"
  elif [ -n "$DELETE" ]; then
    file=$(basename "$source_file")
    rm "$dest_folder/$file"
  elif [ -n "$ADOTP" ]; then
    adopt "$source_file" "$dest_folder"
  else
    ln -s "$source_file" "$dest_folder"
  fi
}

function adopt() {
  local source_file dest_folder
  source_file="$PATH/$1"
  dest_folder=$2
  file=$(basename "$source_file")
  cp -r --force "$dest_folder/$file" "$source_file"
  rm "$dest_folder/$file"
  ln -s "$source_file" "$dest_folder"
}

function main() {
  if [[ ! -f "$NEOSTOW_FILE" ]]; then
    echo "Error: $NEOSTOW_FILE not found"
    exit 1
  fi
  local file_lines i threshold source_file dest_folder working_data
  declare -i file_lines
  declare -i i
  file_lines=$(wc -l <"$NEOSTOW_FILE")
  i=1
  declare -i threshold=("$file_lines"+1)
  while [ "$i" -lt "$threshold" ]; do
    working_data=$(bat --line-range "$i":"$i" "$NEOSTOW_FILE")
    source_file=$(awk -F '=' '{print $1}' <<<"$working_data")
    if [[ -f "$source_file" ]] || [[ -d "$source_file" ]]; then
      dest_folder=$(awk -F '=' '{print $2}' <<<"$working_data")
      eval dest_folder="$dest_folder"
      create_links "$source_file" "$dest_folder"
    fi
    i+=1
    unset working_data
  done
}

while getopts ":hdrt:" opt; do
  case "$opt" in
  r)
    OVERWRITE=true
    ;;
  d)
    DELETE=true
    ;;
  h)
    help
    exit 0
    ;;
  t)
    PATH="$OPTARG"
    NEOSTOW_FILE="$OPTARG/.neostow"
    ;;
  ?)
    echo "Error: Invalid option '-$OPTARG'" >&2
    exit 1
    ;;
  esac
done

shift $((OPTIND - 1))

case "$1" in
help)
  help
  exit 0
  ;;
adopt)
  adopt
  exit 0
  ;;
"")
  main
  ;;
esac
